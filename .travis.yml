sudo: required

language: cpp

matrix:
  include:
    - os: linux
      services: docker
      before_install: 
        - docker pull glportal/whale-gcc:bullet286
        - pip install --user cpp-coveralls
        - pip install --user pyyaml
      script:
        - set -e
        - docker run -it --rm -w /data -v $(pwd):/data glportal/whale-gcc:bullet286 bash -c "cmake -DCOVERALLS=ON -DCMAKE_BUILD_TYPE=Debug ./; make; make tests; make coveralls; ctest;"
      after_success:
        - export COVERALLS_REPO_TOKEN=XcgjR2KjUHOkdLygzBTf6fqDDy3neAMFA
        - export COVERALLS_SERVICE_NAME=travis-ci
        - lcov --directory . --capture --output-file coverage.info # capture coverage info
        - lcov --remove coverage.info 'tests/*' '/usr/*' --output-file coverage.info # filter out system and test code
        - lcov --list coverage.info # debug before upload
        - coveralls --exclude lib --exclude tests --gcov-options '\-lp'
  exclude:
    - os: osx
      osx_image: xcode7.3
      compiler: gcc
      git:
        submodules: false
      before_install:
        - wget "https://github.com/macports/macports-base/releases/download/v2.3.5/MacPorts-2.3.5-10.11-ElCapitan.pkg"
        - travis_wait sudo installer -pkg MacPorts-2.3.5-10.11-ElCapitan.pkg -target /
        - export PATH=/opt/local/bin:/opt/local/sbin:$PATH
        - brew update
      install:
        - sudo port -v install bullet
        - brew install gcc
        - brew install assimp
        - brew install libepoxy
        - brew install sdl2
        - brew install sdl2_mixer
        - brew install bullet
        - brew install tinyxml2
        - brew install unittest-cpp
        - brew install freeimage
      before_script:
        - git submodule update --init --recursive
        - mkdir build && cd build
        - export CC=gcc-6 CXX=g++-6
      script:
        - cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/install ..
        - make -j4
    - os: osx
      osx_image: xcode7.3
      compiler: clang
      git:
        submodules: false
      before_install:
        - wget "https://github.com/macports/macports-base/releases/download/v2.3.5/MacPorts-2.3.5-10.11-ElCapitan.pkg"
        - travis_wait sudo installer -pkg MacPorts-2.3.5-10.11-ElCapitan.pkg -target /
        - export PATH=/opt/local/bin:/opt/local/sbin:$PATH
        - brew update
      install:
        - sudo port -v install bullet
        - rvm get head
        - brew install assimp
        - brew install libepoxy
        - brew install sdl2
        - brew install sdl2_mixer
        - brew install bullet
        - brew install tinyxml2
        - brew install unittest-cpp
        - brew install freeimage
      before_script:
        - git submodule update --init --recursive
        - mkdir build && cd build
      script:
        - set -e
        - cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/install ..
        - make -j4

notifications:
  irc: "chat.freenode.net#glportal"
